name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest

    # Solo ejecutar si es un push a main o un PR mergeado a main
    if: github.event_name == 'push' || (github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          MONGO_ROOT_PASSWORD: ${{ secrets.MONGO_ROOT_PASSWORD }}
          RABBITMQ_PASS: ${{ secrets.RABBITMQ_PASS }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_GATEWAY_URL: ${{ secrets.VITE_GATEWAY_URL }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << EOF
            set -e
            
            echo "============================================"
            echo "ðŸš€ Starting deployment process..."
            echo "============================================"
            
            # Navegar al directorio del proyecto
            cd $DEPLOY_PATH
            
            # Actualizar cÃ³digo desde GitHub
            echo "ðŸ“¥ Pulling latest code from GitHub..."
            git fetch --all
            git reset --hard origin/main
            git pull origin main
            
            # Crear/actualizar archivo .env
            echo "âš™ï¸  Updating environment variables..."
            cat > .env << 'ENVEOF'
          SPRING_PROFILES_ACTIVE=prod
          
          # Database - PostgreSQL
          POSTGRES_USER=postgres
          POSTGRES_PASSWORD=$POSTGRES_PASSWORD
          POSTGRES_PORT=5432
          
          # Database - MongoDB
          MONGO_ROOT_USER=root
          MONGO_ROOT_PASSWORD=$MONGO_ROOT_PASSWORD
          MONGO_PORT=27017
          
          # Message Broker - RabbitMQ
          RABBITMQ_USER=admin
          RABBITMQ_PASS=$RABBITMQ_PASS
          RABBITMQ_PORT=5672
          RABBITMQ_MGMT_PORT=15672
          
          # Microservices Ports
          API_GATEWAY_PORT=8080
          FRONTEND_PORT=80
          
          # Security
          JWT_SECRET=$JWT_SECRET
          
          # Frontend Configuration
          VITE_API_BASE_URL=$VITE_API_BASE_URL
          VITE_GATEWAY_URL=$VITE_GATEWAY_URL
          ENVEOF
            
            # Ejecutar script de deploy
            echo "ðŸ³ Deploying Docker containers..."
            bash scripts/deploy.sh
            
            echo "============================================"
            echo "âœ… Deployment completed successfully!"
            echo "============================================"
          EOF

      - name: Health Check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          API_GATEWAY_PORT: 8080
        run: |
          echo "ðŸ” Running health checks..."
          sleep 60  # Esperar a que los servicios se inicien

          # Health check del API Gateway
          for i in {1..10}; do
            if curl -f http://$EC2_HOST:$API_GATEWAY_PORT/actuator/health; then
              echo "âœ… API Gateway is healthy!"
              exit 0
            fi
            echo "â³ Waiting for API Gateway... (attempt $i/10)"
            sleep 30
          done

          echo "âŒ API Gateway health check failed"
          exit 1

      - name: Notify Deployment Success
        if: success()
        run: |
          echo "============================================"
          echo "ðŸŽ‰ Deployment successful!"
          echo "Frontend: http://${{ secrets.EC2_HOST }}"
          echo "API Gateway: http://${{ secrets.EC2_HOST }}:8080"
          echo "Eureka: http://${{ secrets.EC2_HOST }}:8761"
          echo "============================================"

      - name: Notify Deployment Failure
        if: failure()
        run: |
          echo "============================================"
          echo "âŒ Deployment failed!"
          echo "Please check the logs and EC2 instance"
          echo "============================================"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
