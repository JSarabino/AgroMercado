name: Rollback Deployment

# Workflow manual para hacer rollback a una versiÃ³n anterior
# Ãšsalo en caso de que un deployment cause problemas

on:
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to rollback to (deja vacÃ­o para el commit anterior)'
        required: false
        default: 'HEAD~1'

jobs:
  rollback:
    name: Rollback to Previous Version
    runs-on: ubuntu-latest

    steps:
      - name: Confirm Rollback
        run: |
          echo "============================================"
          echo "âš ï¸  ROLLBACK DEPLOYMENT"
          echo "============================================"
          echo "Target: ${{ github.event.inputs.commit_sha }}"
          echo "This will revert the application to a previous version"
          echo "============================================"

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

      - name: Execute Rollback
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
          COMMIT_SHA: ${{ github.event.inputs.commit_sha }}
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e

            echo "============================================"
            echo "ðŸ”„ Starting rollback process..."
            echo "============================================"

            cd $DEPLOY_PATH

            # Mostrar commit actual
            echo "Current commit:"
            git log -1 --oneline

            # Hacer rollback
            echo ""
            echo "Rolling back to: $COMMIT_SHA"
            git fetch --all
            git reset --hard $COMMIT_SHA

            echo ""
            echo "New commit:"
            git log -1 --oneline

            # Redesplegar
            echo ""
            echo "ðŸ³ Redeploying containers..."
            docker-compose down
            docker-compose up -d --build

            echo "============================================"
            echo "âœ… Rollback completed!"
            echo "============================================"
          ENDSSH

      - name: Wait for Services
        run: |
          echo "â³ Waiting for services to start..."
          sleep 90

      - name: Verify Rollback
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "ðŸ” Verifying services..."

          for i in {1..10}; do
            if curl -f http://$EC2_HOST:8080/actuator/health; then
              echo "âœ… Rollback successful! Services are healthy."
              exit 0
            fi
            echo "â³ Waiting for API Gateway... (attempt $i/10)"
            sleep 30
          done

          echo "âŒ Rollback verification failed"
          exit 1

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Summary
        if: always()
        run: |
          echo "============================================"
          echo "Rollback Summary"
          echo "============================================"
          echo "Target commit: ${{ github.event.inputs.commit_sha }}"
          echo "Status: ${{ job.status }}"
          echo ""
          echo "To rollback again, go to:"
          echo "Actions â†’ Rollback Deployment â†’ Run workflow"
          echo "============================================"
